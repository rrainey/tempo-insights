# Environment Configuration Guide

This document explains the different environment files and when to use each.

## Overview

Tempo Insights uses **three different environment file patterns**:

| File | Purpose | Used By | Committed to Git? |
|------|---------|---------|-------------------|
| `.env.example` | Template/documentation | Developers | ✅ Yes |
| `.env` | Local development | Developer machine | ❌ No |
| `.env.docker` | Docker containers | Production/QA | ❌ No |
| `supabase-stack/.env` | Supabase services | Database stack | ❌ No |

---

## File Purposes

### `.env.example` (Template)
**Purpose**: Documentation and template for required variables  
**Location**: Repository root  
**Committed**: ✅ Yes

Contains:
- All required variable names
- Example/placeholder values
- Comments explaining each variable

```bash
# Example content
JWT_SECRET=super-secret-jwt-token-with-at-least-32-characters-long
DATABASE_URL="postgresql://postgres:postgres@127.0.0.1:54322/postgres"
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
```

**Usage**:
```bash
# Developers copy this to create their local .env
cp .env.example .env
# Then edit .env with real values
```

---

### `.env` (Local Development)
**Purpose**: Developer's local machine configuration  
**Location**: Repository root  
**Committed**: ❌ No (in .gitignore)

Used when:
- Running `pnpm dev` locally
- Running workers with `pnpm worker:bt`
- Direct Prisma migrations

Characteristics:
- Points to localhost services
- May use weaker secrets for convenience
- Specific to each developer's machine

```bash
# Local development example
JWT_SECRET=dev-secret-not-for-production
DATABASE_URL="postgresql://postgres:postgres@localhost:54322/postgres"
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
```

---

### `.env.docker` (Production/QA)
**Purpose**: Docker container configuration  
**Location**: Repository root  
**Committed**: ❌ No (in .gitignore)

Used when:
- Running `docker compose up -d`
- Production deployments
- QA/staging environments

Characteristics:
- Points to Docker service names (e.g., `db` not `localhost`)
- Contains strong, unique secrets
- Generated by `configure-instance.sh`

```bash
# Docker deployment example
JWT_SECRET=<64-char-random-string>
DATABASE_URL=postgresql://postgres:STRONG_PASSWORD@db:5432/postgres
NEXT_PUBLIC_SUPABASE_URL=http://localhost:8000
WORKER_TOKEN=<64-char-random-string>
```

**Key Difference from `.env`**:
- `.env`: `localhost:54322` (host machine)
- `.env.docker`: `db:5432` (Docker network)

---

### `supabase-stack/.env` (Database Stack)
**Purpose**: Supabase service configuration  
**Location**: `supabase-stack/`  
**Committed**: ❌ No (entire directory not committed)

Used by:
- PostgreSQL
- Kong API Gateway
- Supabase Studio
- All 14 Supabase services

Characteristics:
- Downloaded from Supabase official repo
- Configured by `configure-instance.sh`
- Contains database passwords and JWT keys

```bash
# Supabase stack example
POSTGRES_PASSWORD=<strong-random-password>
JWT_SECRET=<same-as-.env.docker>
ANON_KEY=<generated-from-jwt-secret>
SERVICE_ROLE_KEY=<generated-from-jwt-secret>
DASHBOARD_USERNAME=admin
DASHBOARD_PASSWORD=<strong-password>
```

---

## Configuration Workflows

### Local Development Setup

```bash
# 1. Clone repository
git clone <repo>
cd tempo-insights

# 2. Create local environment
cp .env.example .env

# 3. Generate secrets (optional for dev)
./scripts/generate-secrets.sh
# Or use simple dev values

# 4. Edit .env with your values
nano .env

# 5. Set up local Supabase
./scripts/setup-supabase.sh

# 6. Start development
pnpm dev
```

### Production Deployment

```bash
# 1. Run bootstrap script (does everything)
sudo ./configure-instance.sh

# This automatically:
# - Generates .env.docker with strong secrets
# - Creates supabase-stack/.env
# - Saves secrets to .secrets.prod
```

### QA/Staging Deployment

```bash
# Same as production, different environment choice
sudo ./configure-instance.sh
# Select: 2) QA/Staging
```

---

## Environment Variable Reference

### Security & Authentication

```bash
# JWT secret for application tokens (min 32 chars)
JWT_SECRET=<64-char-random-string>

# Supabase JWT keys (generate from JWT_SECRET)
ANON_KEY=<supabase-generated-jwt>
SERVICE_ROLE_KEY=<supabase-generated-jwt>
SUPABASE_SERVICE_KEY=<same-as-service-role-key>

# Worker authentication token (min 64 chars)
WORKER_TOKEN=<64-char-random-string>
```

### Database

```bash
# Application database connection
# Development: localhost:54322
# Docker: db:5432
DATABASE_URL=postgresql://postgres:PASSWORD@HOST:PORT/postgres
```

### Supabase

```bash
# Supabase API URL
# Development: http://localhost:54321
# Docker: http://localhost:8000
NEXT_PUBLIC_SUPABASE_URL=<url>

# Storage bucket name
JUMP_LOG_STORAGE_BUCKET=jump-logs
JUMP_LOG_MAX_SIZE_MB=128
```

### Application

```bash
# Next.js URL (for OAuth callbacks, etc.)
NEXTAUTH_URL=http://localhost:3000

# Node environment
NODE_ENV=production  # or development
```

### Bluetooth Scanner

```bash
# Device discovery window (seconds)
DISCOVERY_WINDOW=300

# smpmgr plugin path
SMPMGR_PLUGIN_PATH=/opt/smpmgr-extensions/plugins
```

---

## Secrets Management

### Development
- Simple secrets OK (e.g., "dev-secret")
- Can share secrets in team
- Store in password manager (optional)

### QA/Staging
- Real secrets (not production strength)
- Documented and shared with team
- Store in password manager

### Production
- Cryptographically strong secrets
- Unique per environment
- **Never reuse between environments**
- Store in enterprise password manager
- Backup `.secrets.prod` file securely

### Generating Strong Secrets

```bash
# Use the provided script
./scripts/generate-secrets.sh

# Or manually:
openssl rand -base64 48 | tr -d "=+/" | cut -c1-64
```

### Rotating Secrets

```bash
# 1. Generate new secrets
./scripts/generate-secrets.sh > new-secrets.txt

# 2. Update .env.docker
nano .env.docker
# Paste new values

# 3. Update supabase-stack/.env
nano supabase-stack/.env
# Paste new values

# 4. Restart services
docker compose down
cd supabase-stack && docker compose down
cd .. && docker compose up -d
cd supabase-stack && docker compose up -d

# 5. Verify everything works
./scripts/validate-env.sh
```

---

## Validation

### Before Starting Services

```bash
# Validate environment configuration
./scripts/validate-env.sh .env.docker

# Expected output:
# ✅ All required variables are set
# ✅ All recommended variables are set
# ✅ No weak secrets detected
# ✅ Validation PASSED
```

### Troubleshooting

**Missing variables:**
```bash
❌ Missing required variables:
   - JWT_SECRET
```
→ Add the variable to your .env file

**Weak secrets:**
```bash
⚠️  Potential security issues:
   - JWT_SECRET (length: 16, recommended: 32+)
```
→ Generate a longer secret

**Wrong host:**
```bash
⚠️  DATABASE_URL uses 'localhost' - should use 'db' for Docker
```
→ Change `localhost` to `db` in `.env.docker`

---

## Migration Between Environments

### From Development to Docker

```bash
# Don't copy .env directly!
# Create new .env.docker with proper hostnames

# Development (.env):
DATABASE_URL=postgresql://postgres:postgres@localhost:54322/postgres

# Docker (.env.docker):
DATABASE_URL=postgresql://postgres:STRONG_PASS@db:5432/postgres
```

### From QA to Production

```bash
# Generate entirely new secrets for production
./scripts/generate-secrets.sh

# Never copy QA secrets to production
# Never copy production secrets to QA
```

---

## Security Best Practices

### ✅ Do:
- Generate unique secrets per environment
- Use minimum 32 characters for secrets
- Store production secrets in password manager
- Backup `.secrets.prod` file securely
- Rotate secrets periodically (quarterly)
- Use `.env.docker` template from repository

### ❌ Don't:
- Commit `.env*` files to git (except `.env.example`)
- Reuse secrets across environments
- Use default/example secrets in production
- Share production secrets via Slack/email
- Store secrets in plain text files on desktop
- Copy `.env` to `.env.docker` without changes

---

## Summary

| Scenario | File to Use | Hostname | Secret Strength |
|----------|-------------|----------|-----------------|
| Local dev | `.env` | localhost | Weak OK |
| Docker dev | `.env.docker` | container names | Medium |
| QA deploy | `.env.docker` | container names | Strong |
| Prod deploy | `.env.docker` | container names | Maximum |

**Remember**: The `configure-instance.sh` script handles all of this automatically for deployments!